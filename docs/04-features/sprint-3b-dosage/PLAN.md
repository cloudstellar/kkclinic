# Implementation Plan: Sprint 3B - Smart Dosage System

**Goal**: Implement "Doctor Instruction → Patient-Friendly Instruction" translation engine based on `docs/04-features/sprint-3b-dosage/SPEC.md`.
**Version**: 1.0

---

> [!IMPORTANT]
> **Tech Stack Compliance**: This implementation must strictly follow `docs/01-constitution/TECH_STACK.md`.

---

## 1. Database Schema Updates
We need to store the "Source of Truth" (raw input) and the "Snapshot" (translated text).

### [MODIFY] `prescription_items` table
*   Add `dosage_original` (text, nullable): Stores the raw shorthand input.
*   Add `dictionary_version` (text, nullable): Stores the version of the dictionary used (e.g., '1.0').
*   Existing `dosage_instruction`: Will now store the projected/translated text (Snapshot).

**Migration Strategy**:
*   For existing rows: Copy current `dosage_instruction` to `dosage_original` (assuming current data is manual entry).
*   Set `dictionary_version` to 'legacy'.

**Constraint Logic**:
*   **Server-Side Assertion** (in `actions.ts`):
    *   If `dictionary_version` is NOT NULL and NOT 'legacy', then `dosage_instruction` MUST NOT be NULL.
*   **DB-Level CHECK Constraint** (recommended for robustness):
    ```sql
    ALTER TABLE prescription_items ADD CONSTRAINT chk_dosage_integrity CHECK (
      (dictionary_version IS NULL) OR
      (dictionary_version = 'legacy' AND dosage_original IS NOT NULL) OR
      (dictionary_version != 'legacy' AND dosage_instruction IS NOT NULL AND dosage_original IS NOT NULL)
    );
    ```

**Field Definitions & Defaults**:
*   `dictionary_version`:
    *   `NULL`: No dosage instruction entered (both `dosage_original` and `dosage_instruction` are also NULL).
    *   `'legacy'`: For existing data or manual entry not utilizing the engine.
    *   `'1.0'`: For instructions generated by Smart Dosage v1.
*   **Save-time Behavior (Strict Rule)**:
    *   If `dosage_original` is empty/blank → set `dosage_original = NULL`, `dosage_instruction = NULL`, `dictionary_version = NULL`.
    *   If `dosage_original` has value → `dictionary_version` MUST be `'legacy'` or `'1.0'` (never NULL).

---

## 2. Engine Implementation (The Core)

### [NEW] `src/lib/dosage/types.ts`
*   Define types: `Token`, `DosagePart` (quantity, unit, site, freq, etc.).
*   **Unknown Token Definition** (Deterministic):
    *   Must NOT be a number.
    *   Must NOT match duration pattern (e.g., `x <n> d`).
    *   Must NOT exist in the dictionary map (case-insensitive lookup).
    *   **Behavior**:
        *   Preserve unknown tokens as they appear in **normalized input** (trimmed + collapsed spaces only). **Do NOT change casing**.
        *   Include in `TranslationResult.unknownTokens` for highlighting.
*   `TranslationResult`:
    ```typescript
    type TranslationResult = {
      lines: string[]
      unknownTokens: string[]
      dictionaryVersion: string
    }
    ```
    *   `lines`: The translated text lines.
    *   `unknownTokens`: List of tokens not found in the dictionary (for UI highlighting).
    *   `dictionaryVersion`: The version used (e.g., '1.0').

### [NEW] `src/lib/dosage/dictionary-v1.ts`
*   Implement the frozen v1.0 dictionary as a constant map.
*   Categories: `Form`, `Site`, `Frequency`, `Condition`, `Duration`.

### [NEW] `src/lib/dosage/tokenizer.ts`
*   Logic to split input string into meaningful tokens.
*   **Normalization Rules**:
    *   Trim input.
    *   Collapse multiple whitespaces -> 1 space.
*   **Token Split**:
    *   Split by whitespace.
    *   **Numeric Separation** (joined tokens):
        *   `2tab` → `2`, `tab`
        *   `1gtt` → `1`, `gtt`
        *   `x7d` → `x`, `7`, `d` (duration pattern)
*   **Case-Insensitive Lookup**:
    *   Store normalized types for lookup (e.g., UPPERCASE for Site, lowercase for Freq).
    *   `ou` matches `OU` in dictionary.

### [NEW] `src/lib/dosage/engine.ts`
*   Main class `SmartDosageEngine`.
*   Method `translate(input: string): TranslationResult`.
*   Implements the fallback logic and sentence construction rules.
*   **Output Formatting (Strict Line Ordering)**:
    1.  Site + Quantity/Form (if present).
    2.  Frequency (+ Condition if present).
    3.  Duration (if present).
    4.  *Remaining unknown tokens appended inline to the nearest relevant line or final line.*
    *   **Fallback**: If no meaningful instruction can be inferred, return single line = original normalized input (with unknown tokens marked).

---

## 3. UI Implementation (2-Pane Editor)

### [MODIFY] `src/components/prescription/dosage-instruction-sheet.tsx`
*   **Split View**:
    *   **Top**: Textarea for `dosage_original` (Raw Input).
    *   **Bottom**: Read-only preview showing the result from `SmartDosageEngine`.
*   **Presets**: Update preset buttons to insert *shorthand tokens* instead of full text.
*   **Debounce**: Implement debounced translation call to avoid lag.
*   **Warnings** (Acceptance Criteria):
    *   **No modal/toast** for unknown tokens.
    *   Unknown tokens must be **visually highlighted in the Preview panel** (underline or subtle color). Editor shows plain text.
    *   Preview must **always render** (never blank or crash) even with garbage input.
    *   User can **still save** (non-blocking) unless server translation fails.

---

## 4. Integration

### [MODIFY] `src/app/(dashboard)/prescriptions/actions.ts`
*   Update `createPrescription` to save `dosage_original`, `dosage_instruction` (snapshot), and `dictionary_version`.
*   Ensure server-side validation/translation (Double check before save).
*   **Authority**: If server-side translation differs from client (rare), use the **Server's result** as the authoritative source of truth.
*   **Failure Behavior**:
    *   **Definition of "Fail"**: Engine throws exception OR returns empty result unexpectedly (not due to empty input).
    *   **Garbage Input** (e.g., `asdf qwer`): NOT a failure. Save snapshot = normalized original input per SPEC "No Guessing" principle.
    *   **Translation Failure**: Reject save with clear error (400). Do not write partial data.
    *   **Mismatch**: Save server snapshot. Optionally return server snapshot to client for UI refresh.

---

## 5. Phase 5: Medicine Summary Sheet (Moved from Sprint 3A+)
*   **Template**: Create `MedicineSummaryTemplate` (Thermal 10x7.5cm, max 11 items).
*   **Logic**: Use the *Snapshot* text (`dosage_instruction`) generated by Smart Dosage.
*   **UI**: Add Checkbox "พิมพ์ใบสรุปรายการยา" in Label Print View.
*   **Integration**: Append summary to the print container efficiently.

---

## 6. Verification Plan

### Automated Tests (Unit Tests)
We will write a test suite for the Engine because it is pure logic.
*   `tests/dosage-engine.test.ts`:
    *   Test Happy Path: `1 gtt OU bid` -> `หยอดตาทั้งสองข้าง ครั้งละ 1 หยด...`
    *   Test Mixed Input: `1 gtt OU and sleep` -> `... and sleep` (Unknown token preserved with original casing).
    *   Test Numeric handling: `2tab` -> `ครั้งละ 2 เม็ด`.
    *   Test Case-Insensitive: `ou` -> same result as `OU`.
    *   Test Whitespace Tolerance: `1  gtt   OU` -> same result as `1 gtt OU`.
    *   Test Duration Joined: `x7d` -> correctly parsed as 7 days.

### Manual Verification
1.  **Migration**: Verify existing prescriptions still load correctly.
2.  **Editor**: Type shorthand -> Check preview updates in real-time.
3.  **Safety**: Type nonsense -> Check preview shows nonsense (no crash, no hallucinations).
4.  **Save/Load**: Save prescription -> Reload -> verify `dosage_original` is loaded back into the editor.
5.  **Print**: Verify the label prints the *Snapshot* text.
6.  **Summary Sheet**: Verify it prints correctly with the new "Patient-Friendly" text.
7.  **Doctor UAT** (Required Cases):
    *   `1 gtt OU bid pc` -> Standard full expansion.
    *   `2 gtt OD qid x 7 d` -> Duration handling.
    *   `PO bid pc` -> Standard form + freq.
    *   `Mixed`: `1 gtt OU bid and sleep` -> Unknown token `and sleep` preserved + underlined.
    *   `Garbage`: `asdf qwer` -> No crash, preview shows raw text.
    *   `Numeric join`: `2tab PO bid` -> Tokenizer splits `2` and `tab` correctly.

---

## 7. Milestones (Test-Driven Breakdown)

> **Principle**: Each milestone has a clear "Done Condition" that can be tested immediately after completion.

| Milestone | Task | Verification (Done When...) |
|-----------|------|----------------------------|
| **M1** | Database Migration + Types | ✅ Migration applied, `npm run typecheck` passes |
| **M2** | Tokenizer Implementation | ✅ Unit test: `"2tab"` → `["2", "tab"]` |
| **M3** | Dictionary V1 (Frozen) | ✅ Unit test: `lookup("OU")` → `"ตาทั้งสองข้าง"` |
| **M4** | Translation Engine | ✅ Unit test: `"1 gtt OU bid"` → Full Thai sentence |
| **M5** | UI 2-Pane Preview | ✅ Manual: Type shorthand → Preview updates live |
| **M6** | Integration (Save/Load) | ✅ Save prescription → Reload → Data persists correctly |
| **M7** | Medicine Summary Sheet | ✅ Print summary with correct "Patient-Friendly" text |

### M1: Database Migration + Types
- [ ] Run migration: add `dosage_original`, `dictionary_version` to `prescription_items`
- [ ] Backfill existing data: `dictionary_version = 'legacy'`
- [ ] Update `src/types/prescriptions.ts`
- [ ] **Test**: `npm run typecheck` passes

### M2: Tokenizer Implementation
- [ ] Create `src/lib/dosage/tokenizer.ts`
- [ ] Implement normalization (trim, collapse spaces)
- [ ] Implement numeric separation (`2tab` → `["2", "tab"]`)
- [ ] **Test**: Unit tests for tokenizer pass

### M3: Dictionary V1 (Frozen)
- [ ] Create `src/lib/dosage/dictionary-v1.ts`
- [ ] Define all categories: Form, Site, Frequency, Condition, Duration
- [ ] Mark as frozen (add version constant `DICT_VERSION = '1.0'`)
- [ ] **Test**: Unit tests for dictionary lookup pass

### M4: Translation Engine
- [ ] Create `src/lib/dosage/engine.ts`
- [ ] Implement `translate(input: string): TranslationResult`
- [ ] Handle unknown tokens (preserve as-is)
- [ ] **Test**: Unit tests for happy path + edge cases pass

### M5: UI 2-Pane Preview
- [ ] Modify `src/components/prescription/dosage-instruction-sheet.tsx`
- [ ] Split view: Editor (top) + Preview (bottom)
- [ ] Debounced translation call
- [ ] Unknown token highlighting
- [ ] **Test**: Manual verification - typing updates preview in real-time

### M6: Integration (Save/Load)
- [ ] Update `src/app/(dashboard)/prescriptions/actions.ts`
- [ ] Save `dosage_original`, `dosage_instruction` (snapshot), `dictionary_version`
- [ ] Server-side translation authority
- [ ] **Test**: Create prescription → Reload page → All fields intact

### M7: Medicine Summary Sheet
- [ ] Create `MedicineSummaryTemplate` component
- [ ] Thermal 10x7.5cm layout (max 11 items)
- [ ] Add checkbox "พิมพ์ใบสรุปรายการยา" in Label Print View
- [ ] **Test**: Print produces correct summary with translated dosage

## 8. Final DoD + Acceptance Criteria

To consider Sprint 3B "Done", the following criteria must be met:

### Schema & Data Integrity
- [ ] `prescription_items` table has `dosage_original` and `dictionary_version`.
- [ ] Existing data migrated with `dictionary_version = 'legacy'`.
- [ ] Server refuses to save (400) if `dictionary_version != 'legacy'` but `dosage_instruction` is NULL.

### Smart Dosage Engine
- [ ] Tokenizer handles numeric separation (`2tab` -> `2`, `tab`) and normalization.
- [ ] Unknown tokens are strictly defined (not number, not duration pattern, not in map).
- [ ] Dictionary V1 is implemented as a frozen constant.
- [ ] Output formatting follows strict line ordering (Site -> Freq -> Duration).

### User Interface (Dosage Sheet)
- [ ] Two-pane split view (Editor / Preview) implemented.
- [ ] Typing shorthand updates preview in real-time (debounced).
- [ ] **NO** blocking modals for unknown tokens.
- [ ] Unknown tokens are visually highlighted (underline/color).
- [ ] Presets insert SHORTHAND text (e.g., "1 tab"), not full text.

### Integration
- [ ] Label printing uses the *Snapshot* (`dosage_instruction`), never the raw input.
- [ ] Medicine Summary Sheet prints correctly using the same snapshot.
- [ ] Unit tests for Engine pass (covering happy path, mixed, garbage, numeric split).
- [ ] Doctor UAT sign-off on the 5-6 key scenarios (Mixed input, numeric join, etc.).


**This section constitutes the authoritative DoD for Sprint 3B.**
