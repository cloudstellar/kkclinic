# Implementation Plan: Sprint 3B - Smart Dosage System

**Goal**: Implement "Doctor Instruction → Patient-Friendly Instruction" translation engine based on `SPEC_SMART_DOSAGE_V1.md`.
**Version**: 1.0

---

## 1. Database Schema Updates
We need to store the "Source of Truth" (raw input) and the "Snapshot" (translated text).

### [MODIFY] `prescription_items` table
*   Add `dosage_original` (text, nullable): Stores the raw shorthand input.
*   Add `dictionary_version` (text, nullable): Stores the version of the dictionary used (e.g., '1.0').
*   Existing `dosage_instruction`: Will now store the projected/translated text (Snapshot).

**Migration Strategy**:
*   For existing rows: Copy current `dosage_instruction` to `dosage_original` (assuming current data is manual entry).
*   Set `dictionary_version` to 'legacy'.

**Constraint Logic (Server-Side Assertion)**:
*   If `dictionary_version` is NOT 'legacy', then `dosage_instruction` MUST NOT be NULL.
*   This ensures that any fresh translation always has a snapshot saved.

**Field Definitions & Defaults**:
*   `dictionary_version`:
    *   `'legacy'`: For existing data or manual entry not utilizing the engine.
    *   `'1.0'`: For instructions generated by Smart Dosage v1.
*   **Save-time Behavior**:
    *   If `dosage_original` is empty -> `dictionary_version` should be `null` (or `'legacy'` if preferred, to keep it simple).
    *   If `dosage_original` is NOT empty and engine was used -> `dictionary_version` = `'1.0'`. (Reduces ambiguity).

---

## 2. Engine Implementation (The Core)

### [NEW] `src/lib/dosage/types.ts`
*   Define types: `Token`, `DosagePart` (quantity, unit, site, freq, etc.).
*   **Unknown Token Definition** (Deterministic):
    *   Must NOT be a number.
    *   Must NOT match duration pattern (e.g., `x <n> d`).
    *   Must NOT exist in the dictionary map (case-insensitive).
    *   **Behavior**:
        *   Preserve in output exactly as is (using the normalized casing/spacing).
        *   Include in `TranslationResult.unknownTokens` for highlighting.
*   `TranslationResult`:
    ```typescript
    type TranslationResult = {
      lines: string[]
      unknownTokens: string[]
      dictionaryVersion: string
    }
    ```
    *   `lines`: The translated text lines.
    *   `unknownTokens`: List of tokens not found in the dictionary (for UI highlighting).
    *   `dictionaryVersion`: The version used (e.g., '1.0').

### [NEW] `src/lib/dosage/dictionary-v1.ts`
*   Implement the frozen v1.0 dictionary as a constant map.
*   Categories: `Form`, `Site`, `Frequency`, `Condition`, `Duration`.

### [NEW] `src/lib/dosage/tokenizer.ts`
*   Logic to split input string into meaningful tokens.
*   **Normalization Rules**:
    *   Trim input.
    *   Collapse multiple whitespaces -> 1 space.
*   **Token Split**:
    *   Split by whitespace.
    *   **Numeric Separation**:
        *   `2tab` -> `2`, `tab`
        *   `1gtt` -> `1`, `gtt`
*   **Case-Insensitive Lookup**:
    *   Store normalized types for lookup (e.g., UPPERCASE for Site, lowercase for Freq).

### [NEW] `src/lib/dosage/engine.ts`
*   Main class `SmartDosageEngine`.
*   Method `translate(input: string): TranslationResult`.
*   Implements the fallback logic and sentence construction rules.
*   **Output Formatting (Strict Line Ordering)**:
    1.  Site + Quantity/Form (if present).
    2.  Frequency (+ Condition if present).
    3.  Duration (if present).
    4.  *Remaining unknown tokens appended inline to the nearest relevant line or final line.*
    *   **Fallback**: If no meaningful instruction can be inferred, return single line = original normalized input (with unknown tokens marked).

---

## 3. UI Implementation (2-Pane Editor)

### [MODIFY] `src/components/prescription/dosage-instruction-sheet.tsx`
*   **Split View**:
    *   **Top**: Textarea for `dosage_original` (Raw Input).
    *   **Bottom**: Read-only preview showing the result from `SmartDosageEngine`.
*   **Presets**: Update preset buttons to insert *shorthand tokens* instead of full text.
*   **Debounce**: Implement debounced translation call to avoid lag.
*   **Warnings** (Acceptance Criteria):
    *   **No modal/toast** for unknown tokens.
    *   Unknown tokens must be **visually indicated** in the editor (underline or subtle color).
    *   Preview must **always render** (never blank or crash) even with garbage input.
    *   User can **still save** (non-blocking) unless server translation fails.

---

## 4. Integration

### [MODIFY] `src/app/(dashboard)/prescriptions/actions.ts`
*   Update `createPrescription` to save `dosage_original`, `dosage_instruction` (snapshot), and `dictionary_version`.
*   Update `createPrescription` to save `dosage_original`, `dosage_instruction` (snapshot), and `dictionary_version`.
*   Ensure server-side validation/translation (Double check before save).
*   **Authority**: If server-side translation differs from client (rare), use the **Server's result** as the authoritative source of truth.
*   **Failure Behavior**:
    *   **Translation Failure**: Reject save with clear error (400). Do not write partial data.
    *   **Mismatch**: Save server snapshot. Optionally return server snapshot to client for UI refresh.

---

## 5. Phase 5: Medicine Summary Sheet (Moved from Sprint 3A+)
*   **Template**: Create `MedicineSummaryTemplate` (Thermal 10x7.5cm, max 11 items).
*   **Logic**: Use the *Snapshot* text (`dosage_instruction`) generated by Smart Dosage.
*   **UI**: Add Checkbox "พิมพ์ใบสรุปรายการยา" in Label Print View.
*   **Integration**: Append summary to the print container efficiently.

---

## 6. Verification Plan

### Automated Tests (Unit Tests)
We will write a test suite for the Engine because it is pure logic.
*   `tests/dosage-engine.test.ts`:
    *   Test Happy Path: `1 gtt OU bid` -> `หยอดตาทั้งสองข้าง ครั้งละ 1 หยด...`
    *   Test Mixed Input: `1 gtt OU and sleep` -> `... and sleep` (Unknown token preserved).
    *   Test Numeric handling: `2tab` -> `ครั้งละ 2 เม็ด`.

### Manual Verification
1.  **Migration**: Verify existing prescriptions still load correctly.
2.  **Editor**: Type shorthand -> Check preview updates in real-time.
3.  **Safety**: Type nonsense -> Check preview shows nonsense (no crash, no hallucinations).
4.  **Save/Load**: Save prescription -> Reload -> verify `dosage_original` is loaded back into the editor.
5.  **Print**: Verify the label prints the *Snapshot* text.
6.  **Summary Sheet**: Verify it prints correctly with the new "Patient-Friendly" text.
7.  **Doctor UAT** (Required Cases):
    *   `1 gtt OU bid pc` -> Standard full expansion.
    *   `2 gtt OD qid x 7 d` -> Duration handling.
    *   `PO bid pc` -> Standard form + freq.
    *   `Mixed`: `1 gtt OU bid and sleep` -> Unknown token `and sleep` preserved + underlined.
    *   `Garbage`: `asdf qwer` -> No crash, preview shows raw text.
    *   `Numeric join`: `2tab PO bid` -> Tokenizer splits `2` and `tab` correctly.

---

## 7. Task Breakdown (Sprint 3B)

1.  **Task 1**: Database Migration & Types
2.  **Task 2**: Implement Tokenizer & Dictionary V1
3.  **Task 3**: Implement Translation Engine & Unit Tests
4.  **Task 4**: Update UI (DosageInstructionSheet) & Presets
5.  **Task 5**: Integration & End-to-End Testing
6.  **Task 6**: Implement Medicine Summary Sheet & Final Verification

## 8. Final DoD + Acceptance Criteria

To consider Sprint 3B "Done", the following criteria must be met:

### Schema & Data Integrity
- [ ] `prescription_items` table has `dosage_original` and `dictionary_version`.
- [ ] Existing data migrated with `dictionary_version = 'legacy'`.
- [ ] Server refuses to save (400) if `dictionary_version != 'legacy'` but `dosage_instruction` is NULL.

### Smart Dosage Engine
- [ ] Tokenizer handles numeric separation (`2tab` -> `2`, `tab`) and normalization.
- [ ] Unknown tokens are strictly defined (not number, not duration pattern, not in map).
- [ ] Dictionary V1 is implemented as a frozen constant.
- [ ] Output formatting follows strict line ordering (Site -> Freq -> Duration).

### User Interface (Dosage Sheet)
- [ ] Two-pane split view (Editor / Preview) implemented.
- [ ] Typing shorthand updates preview in real-time (debounced).
- [ ] **NO** blocking modals for unknown tokens.
- [ ] Unknown tokens are visually highlighted (underline/color).
- [ ] Presets insert SHORTHAND text (e.g., "1 tab"), not full text.

### Integration
- [ ] Label printing uses the *Snapshot* (`dosage_instruction`), never the raw input.
- [ ] Medicine Summary Sheet prints correctly using the same snapshot.
- [ ] Unit tests for Engine pass (covering happy path, mixed, garbage, numeric split).
- [ ] Doctor UAT sign-off on the 5-6 key scenarios (Mixed input, numeric join, etc.).


**This section constitutes the authoritative DoD for Sprint 3B.**
