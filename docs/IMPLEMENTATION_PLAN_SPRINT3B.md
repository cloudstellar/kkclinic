# Implementation Plan: Sprint 3B - Smart Dosage System

**Goal**: Implement "Doctor Instruction → Patient-Friendly Instruction" translation engine based on `SPEC_SMART_DOSAGE_V1.md`.
**Version**: 1.0

---

## 1. Database Schema Updates
We need to store the "Source of Truth" (raw input) and the "Snapshot" (translated text).

### [MODIFY] `prescription_items` table
*   Add `dosage_original` (text, nullable): Stores the raw shorthand input.
*   Add `dictionary_version` (text, nullable): Stores the version of the dictionary used (e.g., '1.0').
*   Existing `dosage_instruction`: Will now store the projected/translated text (Snapshot).

**Migration Strategy**:
*   For existing rows: Copy current `dosage_instruction` to `dosage_original` (assuming current data is manual entry).
*   Set `dictionary_version` to 'legacy'.

---

## 2. Engine Implementation (The Core)

### [NEW] `src/lib/dosage/types.ts`
*   Define types: `Token`, `TranslationResult`, `DosagePart` (quantity, unit, site, freq, etc.).

### [NEW] `src/lib/dosage/dictionary-v1.ts`
*   Implement the frozen v1.0 dictionary as a constant map.
*   Categories: `Form`, `Site`, `Frequency`, `Condition`, `Duration`.

### [NEW] `src/lib/dosage/tokenizer.ts`
*   Logic to split input string into meaningful tokens.
*   Handle numeric separation (e.g., `2tab` -> `2`, `tab`).

### [NEW] `src/lib/dosage/engine.ts`
*   Main class `SmartDosageEngine`.
*   Method `translate(input: string): TranslationResult`.
*   Implements the fallback logic and sentence construction rules.

---

## 3. UI Implementation (2-Pane Editor)

### [MODIFY] `src/components/prescription/dosage-instruction-sheet.tsx`
*   **Split View**:
    *   **Top**: Textarea for `dosage_original` (Raw Input).
    *   **Bottom**: Read-only preview showing the result from `SmartDosageEngine`.
*   **Presets**: Update preset buttons to insert *shorthand tokens* instead of full text.
*   **Debounce**: Implement debounced translation call to avoid lag.
*   **Warnings**: Display "Unknown Token" alerts non-intrusively.

---

## 4. Integration

### [MODIFY] `src/app/(dashboard)/prescriptions/actions.ts`
*   Update `createPrescription` to save `dosage_original`, `dosage_instruction` (snapshot), and `dictionary_version`.
*   Ensure server-side validation/translation (Double check before save).

---

## 5. Phase 5: Medicine Summary Sheet (Moved from Sprint 3A+)
*   **Template**: Create `MedicineSummaryTemplate` (Thermal 10x7.5cm, max 11 items).
*   **Logic**: Use the *Snapshot* text (`dosage_instruction`) generated by Smart Dosage.
*   **UI**: Add Checkbox "พิมพ์ใบสรุปรายการยา" in Label Print View.
*   **Integration**: Append summary to the print container efficiently.

---

## 6. Verification Plan

### Automated Tests (Unit Tests)
We will write a test suite for the Engine because it is pure logic.
*   `tests/dosage-engine.test.ts`:
    *   Test Happy Path: `1 gtt OU bid` -> `หยอดตาทั้งสองข้าง ครั้งละ 1 หยด...`
    *   Test Mixed Input: `1 gtt OU and sleep` -> `... and sleep` (Unknown token preserved).
    *   Test Numeric handling: `2tab` -> `ครั้งละ 2 เม็ด`.

### Manual Verification
1.  **Migration**: Verify existing prescriptions still load correctly.
2.  **Editor**: Type shorthand -> Check preview updates in real-time.
3.  **Safety**: Type nonsense -> Check preview shows nonsense (no crash, no hallucinations).
4.  **Save/Load**: Save prescription -> Reload -> verify `dosage_original` is loaded back into the editor.
5.  **Print**: Verify the label prints the *Snapshot* text.
6.  **Summary Sheet**: Verify it prints correctly with the new "Patient-Friendly" text.

---

## 7. Task Breakdown (Sprint 3B)

1.  **Task 1**: Database Migration & Types
2.  **Task 2**: Implement Tokenizer & Dictionary V1
3.  **Task 3**: Implement Translation Engine & Unit Tests
4.  **Task 4**: Update UI (DosageInstructionSheet) & Presets
5.  **Task 5**: Integration & End-to-End Testing
6.  **Task 6**: Implement Medicine Summary Sheet & Final Verification
