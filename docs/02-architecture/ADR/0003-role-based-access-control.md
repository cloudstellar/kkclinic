# ADR 0003: Role-Based Access Control for Billing & Dispensing

**Status:** Accepted  
**Date:** 2025-01-25  
**Context:** Sprint 4 complete, Sprint 5 planning

## Context

> **Doctor role** à¹ƒà¸™à¸£à¸°à¸šà¸šà¸™à¸µà¹‰à¸«à¸¡à¸²à¸¢à¸–à¸¶à¸‡ **à¹à¸žà¸—à¸¢à¹Œà¹€à¸ˆà¹‰à¸²à¸‚à¸­à¸‡à¸„à¸¥à¸´à¸™à¸´à¸ (Owner)** à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ associate physician

### Real World Flow

```
1. à¸«à¸¡à¸­à¸ªà¸£à¹‰à¸²à¸‡ Rx
2. à¸«à¸¡à¸­à¸à¸” "à¸Šà¸³à¸£à¸°" (= à¸ªà¸£à¸¸à¸›à¹€à¸„à¸ª, à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸£à¸±à¸šà¹€à¸‡à¸´à¸™à¸ˆà¸£à¸´à¸‡)
3. à¸«à¸¡à¸­à¸žà¸´à¸¡à¸žà¹Œà¹ƒà¸šà¹€à¸ªà¸£à¹‡à¸ˆ+à¸‰à¸¥à¸²à¸ (à¸ªà¹ˆà¸‡à¹ƒà¸«à¹‰ staff)
4. Stock à¸•à¸±à¸” à¸“ à¸ˆà¸¸à¸”à¸™à¸µà¹‰
5. Staff à¹€à¸à¹‡à¸šà¹€à¸‡à¸´à¸™à¸ˆà¸£à¸´à¸‡à¸ˆà¸²à¸à¸„à¸™à¹„à¸‚à¹‰
6. à¸–à¹‰à¸²à¸„à¸™à¹„à¸‚à¹‰à¸„à¸·à¸™à¸¢à¸² â†’ Staff adjust â†’ Stock à¸„à¸·à¸™
```

## Decision

### Access Control Matrix

| Route / Action | Admin | Doctor | Staff |
|----------------|-------|--------|-------|
| `/billing` (à¸ªà¸£à¸¸à¸›à¸£à¸²à¸¢à¸§à¸±à¸™) | âœ… | âœ… (à¹€à¸ˆà¹‰à¸²à¸‚à¸­à¸‡) | âŒ â†’ redirect `/frontdesk` |
| `/frontdesk` (à¸‡à¸²à¸™à¸«à¸™à¹‰à¸²à¸šà¹‰à¸²à¸™) | âœ… | âœ… | âœ… (default landing) |
| `/prescriptions/[id]` | âœ… | âœ… | âœ… |
| Receipt view | âœ… | âœ… | âœ… |
| Payment/à¸ªà¸£à¸¸à¸›à¹€à¸„à¸ª | âœ… | âœ… | âŒ (à¸«à¸¡à¸­à¸—à¸³) |
| Adjust (à¸›à¸£à¸±à¸šà¸£à¸²à¸¢à¸à¸²à¸£) | âœ… | âœ… | âœ… |
| Void (à¸¢à¸à¹€à¸¥à¸´à¸) | âœ… | âœ… | âŒ |

> **Adjust = Reduce / Remove only** â€” à¸«à¹‰à¸²à¸¡à¹€à¸žà¸´à¹ˆà¸¡ qty, à¸«à¹‰à¸²à¸¡à¹€à¸žà¸´à¹ˆà¸¡à¸£à¸²à¸¢à¸à¸²à¸£, à¸«à¹‰à¸²à¸¡à¹à¸à¹‰à¸£à¸²à¸„à¸²

### Staff Default Landing = `/frontdesk`

```
/frontdesk
â”œâ”€â”€ Card 1: à¸œà¸¹à¹‰à¸›à¹ˆà¸§à¸¢
â”‚   â”œâ”€â”€ à¸„à¹‰à¸™à¸«à¸²à¸œà¸¹à¹‰à¸›à¹ˆà¸§à¸¢
â”‚   â””â”€â”€ âž• à¹€à¸žà¸´à¹ˆà¸¡à¸œà¸¹à¹‰à¸›à¹ˆà¸§à¸¢à¹ƒà¸«à¸¡à¹ˆ
â”‚
â”œâ”€â”€ Card 2: à¸‡à¸²à¸™à¸§à¸±à¸™à¸™à¸µà¹‰
â”‚   â”œâ”€â”€ Tab: à¸£à¸­à¸ªà¸£à¸¸à¸›à¹€à¸„à¸ª (Rx à¸—à¸µà¹ˆà¸«à¸¡à¸­à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸à¸”)
â”‚   â””â”€â”€ Tab: à¸ªà¸£à¸¸à¸›à¹€à¸„à¸ªà¹à¸¥à¹‰à¸§ (transactions à¸§à¸±à¸™à¸™à¸µà¹‰) â† Staff à¸—à¸³à¸‡à¸²à¸™à¸«à¸¥à¸±à¸
â”‚
â””â”€â”€ âŒ à¹„à¸¡à¹ˆà¸¡à¸µà¸¢à¸­à¸”à¸ªà¸£à¸¸à¸›
```

### UI Changes

1. **"à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸£à¸²à¸¢à¸à¸²à¸£"** â†’ à¹€à¸¡à¸™à¸¹ "â‹¯ à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡"
2. **Void** â†’ à¸‹à¹ˆà¸­à¸™à¸ªà¸³à¸«à¸£à¸±à¸š staff
3. **Nav** â†’ à¸‹à¹ˆà¸­à¸™ `/billing` à¸ªà¸³à¸«à¸£à¸±à¸š staff

### Guards

- Route guards: Redirect unauthorized
- Server action guards: Return error
- UI guards: Hide buttons/menus

### Data Enforcement (Server-side)

> Adjust validated at server (`createAdjustment`):
> - `new_qty â‰¤ effective_qty` (à¸«à¹‰à¸²à¸¡à¹€à¸žà¸´à¹ˆà¸¡)
> - `new_qty â‰¥ 0` (à¸«à¹‰à¸²à¸¡à¸•à¸´à¸”à¸¥à¸š)
> - à¸«à¹‰à¸²à¸¡à¹€à¸žà¸´à¹ˆà¸¡à¸£à¸²à¸¢à¸à¸²à¸£à¹ƒà¸«à¸¡à¹ˆ
> - à¸«à¹‰à¸²à¸¡à¹à¸à¹‰à¸£à¸²à¸„à¸² (à¹ƒà¸Šà¹‰ unit_price à¸ˆà¸²à¸ base snapshot)

> Void:
> - Staff à¹€à¸«à¹‡à¸™à¸ªà¸–à¸²à¸™à¸° void à¹„à¸”à¹‰ (read-only badge "à¸¢à¸à¹€à¸¥à¸´à¸")
> - Staff à¸—à¸³ void à¹„à¸¡à¹ˆà¹„à¸”à¹‰ (UI + server guard)

## Consequences

- Staff à¸—à¸³à¸‡à¸²à¸™à¹„à¸”à¹‰à¸„à¸£à¸šà¸—à¸µà¹ˆà¸«à¸™à¹‰à¸²à¹€à¸”à¸µà¸¢à¸§
- à¹„à¸¡à¹ˆà¹€à¸«à¹‡à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸²à¸‡à¸à¸²à¸£à¹€à¸‡à¸´à¸™à¸£à¸§à¸¡
- à¸¥à¸”à¸„à¸§à¸²à¸¡à¹€à¸ªà¸µà¹ˆà¸¢à¸‡à¸ˆà¸²à¸à¸à¸²à¸£ void à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸£à¸±à¸šà¸­à¸™à¸¸à¸à¸²à¸•

## Related

- Sprint 4: `/docs/04-features/sprint-4-adjustment/PLAN.md`
- Sprint 5: `/docs/04-features/sprint-5/PLAN.md`

---

## Sprint 5 Page Conditions Summary

### `/frontdesk` (Staff)

| Condition | Behavior |
|-----------|----------|
| **Tab "à¸£à¸­à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£"** | Transaction à¸§à¸±à¸™à¸™à¸µà¹‰ + `voided_at IS NULL` + `closed_at IS NULL` |
| **à¸›à¸¸à¹ˆà¸¡ "à¸›à¸´à¸”à¸‡à¸²à¸™"** | à¸à¸”à¹„à¸”à¹‰à¸—à¸¸à¸ transaction à¸—à¸µà¹ˆà¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸›à¸´à¸” |
| **à¸à¸”à¸›à¸´à¸”à¸‡à¸²à¸™** | Card à¸«à¸²à¸¢à¸ˆà¸²à¸ list (optimistic) |
| **Voided transaction** | à¹à¸ªà¸”à¸‡ badge "à¸¢à¸à¹€à¸¥à¸´à¸" à¹„à¸¡à¹ˆà¸¡à¸µà¸›à¸¸à¹ˆà¸¡à¸›à¸´à¸”à¸‡à¸²à¸™ |
| **à¸‚à¹‰à¸²à¸¡à¸§à¸±à¸™ (à¹€à¸—à¸µà¹ˆà¸¢à¸‡à¸„à¸·à¸™)** | à¸£à¸²à¸¢à¸à¸²à¸£à¹€à¸à¹ˆà¸²à¸«à¸²à¸¢à¸ˆà¸²à¸ "à¸§à¸±à¸™à¸™à¸µà¹‰" |

### `/dispensing` (Doctor)

| Condition | Behavior |
|-----------|----------|
| **Default** | à¹à¸ªà¸”à¸‡ "à¸£à¸²à¸¢à¸à¸²à¸£à¸§à¸±à¸™à¸™à¸µà¹‰" |
| **à¸”à¸¹à¸¢à¹‰à¸­à¸™à¸«à¸¥à¸±à¸‡** | Link à¹€à¸¥à¹‡à¸à¹ƒà¸•à¹‰ title â†’ à¹‚à¸«à¸¥à¸” 20 à¸£à¸²à¸¢à¸à¸²à¸£à¸¥à¹ˆà¸²à¸ªà¸¸à¸” |
| **Empty + â‰¥21:00** | à¹à¸ªà¸”à¸‡ link "ðŸ‘‰ à¸”à¸¹à¸£à¸²à¸¢à¸à¸²à¸£à¸¥à¹ˆà¸²à¸ªà¸¸à¸”" |
| **History view** | à¹à¸ªà¸”à¸‡ label "ðŸ“œ à¸£à¸²à¸¢à¸à¸²à¸£à¸¥à¹ˆà¸²à¸ªà¸¸à¸” (à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸§à¸±à¸™à¸™à¸µà¹‰)" |
| **à¸›à¸¸à¹ˆà¸¡ "à¸à¸¥à¸±à¸šà¹„à¸›à¸§à¸±à¸™à¸™à¸µà¹‰"** | Reset à¸à¸¥à¸±à¸š default view |

> **Badge Policy:** "In the dispensing view, badges are reserved only for unfinished clinical tasks. Completed items are reference-only and do not require counts."

### Timezone

- à¹ƒà¸Šà¹‰ `Asia/Bangkok` (UTC+7) à¸•à¸¥à¸­à¸”
- Helper: `getTodayRange('Asia/Bangkok')` â†’ `{ start, nextStart }`
- Query: `.gte(start).lt(nextStart)` (exclusive end)

