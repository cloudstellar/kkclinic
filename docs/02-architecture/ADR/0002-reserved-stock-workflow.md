# ADR-0002: Reserved Stock Workflow

**Date**: 2026-01-24  
**Status**: Accepted  
**Deciders**: Owner (‡∏´‡∏°‡∏≠), AI Assistant

---

## Context

‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏±‡∏Å‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏¢‡∏≤‡∏ï‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÅ‡∏ï‡πà workflow ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏°‡∏µ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á:
1. ‡∏´‡∏°‡∏≠‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤ (‡∏™‡∏£‡πâ‡∏≤‡∏á prescription)
2. **Staff ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£** ‚Üê ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
3. ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤

‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö:
- Staff ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡πä‡∏Å‡∏¢‡∏≤‡∏ö‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å (‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å, ‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£, etc.)
- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏ö "‡∏à‡∏≠‡∏á" ‡∏™‡∏ï‡πá‡∏≠‡∏Å ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
- ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô UI ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢

---

## Decision

### 1. Prescription Status Flow

```
pending ‚îÄ‚îÄ‚Üí confirmed ‚îÄ‚îÄ‚Üí paid
```

| Status | ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢ | Action |
|--------|----------|--------|
| `pending` | ‡∏´‡∏°‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤ | ‡∏™‡∏ï‡πá‡∏≠‡∏Å RESERVED |
| `confirmed` | Staff ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ | ‡∏Ñ‡∏∑‡∏ô reserved ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡πä‡∏Å‡∏≠‡∏≠‡∏Å |
| `paid` | ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß | ‡∏™‡∏ï‡πá‡∏≠‡∏Å DEDUCTED |

### 2. Database Schema Changes

```sql
-- prescriptions: ‡πÄ‡∏û‡∏¥‡πà‡∏° status column
ALTER TABLE prescriptions ADD COLUMN status text DEFAULT 'pending';

-- prescription_items: ‡πÄ‡∏û‡∏¥‡πà‡∏° is_dispensed flag
ALTER TABLE prescription_items ADD COLUMN is_dispensed boolean DEFAULT true;

-- medicines: ‡πÄ‡∏û‡∏¥‡πà‡∏° reserved_qty
ALTER TABLE medicines ADD COLUMN reserved_qty integer DEFAULT 0;
```

### 3. Variable Naming Convention

| ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | Variable | ‡∏ï‡∏≤‡∏£‡∏≤‡∏á |
|--------|----------|-------|
| ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏≠‡∏™‡∏±‡πà‡∏á | `total_amount` | `prescriptions` |
| ‡∏¢‡∏≠‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢ | `total_amount` | `transactions` |
| ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢/‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢ | `is_dispensed` | `prescription_items` |
| ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤ | `status` | `prescriptions` |

### 4. Doctor Fee (DF) Rule

> **DF ‡∏ï‡∏¥‡πä‡∏Å‡∏≠‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ** - ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏™‡∏°‡∏≠

‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ (`prescription_items`) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà Staff ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡πä‡∏Å‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ

### 5. Document Flow (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà)

#### üìã ‡∏´‡∏°‡∏≠‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤ (status = pending)

‡∏´‡∏°‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ Staff:

| ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ | ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ | ‡∏°‡∏µ receipt_no? |
|--------|----------|---------------|
| **‡πÉ‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢** | ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤ + DF + ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏¢‡∏±‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ) | ‚ùå |
| **‡∏™‡∏•‡∏≤‡∏Å‡∏¢‡∏≤** | ‡∏õ‡πâ‡∏≤‡∏¢‡∏ï‡∏¥‡∏î‡∏ã‡∏≠‡∏á‡∏¢‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤, ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ) | ‚ùå |
| **‡πÉ‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤** | ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Staff ‡∏´‡∏¢‡∏¥‡∏ö (‡∏°‡∏µ checkbox) | ‚ùå |

> [!NOTE]
> ‡∏ó‡∏±‡πâ‡∏á 3 ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏≠‡∏ô‡∏´‡∏°‡∏≠‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤ **‡∏Å‡πà‡∏≠‡∏ô** Staff ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô

#### ‚úÖ ‡∏´‡∏•‡∏±‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (status = paid)

| ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ | ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ | ‡∏°‡∏µ receipt_no? |
|--------|----------|---------------|
| **‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô** | ‡∏¢‡∏≠‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢ (‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏¥‡πä‡∏Å‡∏¢‡∏≤‡∏≠‡∏≠‡∏Å) | ‚úÖ |

> [!CAUTION]
> **‡∏≠‡∏¢‡πà‡∏≤‡∏£‡∏∑‡πâ‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏î‡∏¥‡∏°!**
> - ‡∏´‡∏ô‡πâ‡∏≤ `/billing/receipt/[id]` ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
> - **‡πÅ‡∏Ñ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô UI label** ‡∏à‡∏≤‡∏Å "‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à" ‚Üí "‡πÉ‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢" (‡∏Å‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô)
> - **‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á** ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠ refactor ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°
> - ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î (`receipt_no`, `receipt-view.tsx`) **‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠**

---

### 6. Technical Guardrails (Implementation Constraints)

> [!WARNING]
> ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô **‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö** ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô data inconsistency ‡πÅ‡∏•‡∏∞ race condition

#### 6.1 Stock Reservation Rules

**‡∏ô‡∏¥‡∏¢‡∏≤‡∏°:**
```
available_qty = on_hand_qty - reserved_qty
```
*(‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)*

**‡∏Å‡πà‡∏≠‡∏ô reserve ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à:**
- `available_qty >= requested_qty` ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏à‡∏∂‡∏á‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ reserve

**‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:**
- ‚ùå `reserved_qty < 0`
- ‚ùå `reserved_qty > on_hand_qty`

#### 6.2 Atomicity / Concurrency

- ‡∏Å‡∏≤‡∏£ reserve ‡πÅ‡∏•‡∏∞ release **‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö atomic** ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô DB transaction (‡∏´‡∏£‡∏∑‡∏≠ RPC ‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏≠‡∏ö transaction)
- ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô **race condition** ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á prescription ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
- ‚ùå **‡∏´‡πâ‡∏≤‡∏°** ‡∏ó‡∏≥ reserve/release ‡πÅ‡∏ö‡∏ö "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏ô client ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ update" ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà lock/transaction

#### 6.3 Status-based Mutability (Locking Rules)

**‡πÄ‡∏°‡∏∑‡πà‡∏≠ `status != 'pending'`:**
- ‚ùå ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡πÉ‡∏ô prescription (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö/‡πÅ‡∏Å‡πâ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)
- ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö `is_dispensed` ‡πÇ‡∏î‡∏¢ Staff ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á `confirmed` ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô

**‡πÄ‡∏°‡∏∑‡πà‡∏≠ `status = 'paid'`:**
- ‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• `prescriptions` ‡πÅ‡∏•‡∏∞ `prescription_items` ‡∏ï‡πâ‡∏≠‡∏á **immutable** (‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ)
- ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡∏î‡∏π" ‡πÅ‡∏•‡∏∞ "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ã‡πâ‡∏≥" ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£/‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
- üìã Any correction after `paid` must be handled via a **separate workflow** (e.g. refund ADR), not by editing this prescription.

---

### 7. Out of Scope for Sprint 5 (Explicit Non-goals)

> [!CAUTION]
> ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô **‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏≥‡πÉ‡∏ô Sprint 5** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ implement ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏à‡∏ô‡πÄ‡∏Å‡∏¥‡∏î chaos

- ‚ùå **Cancel prescription** ‚Äî ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥
- ‚ùå **Refund / Return to stock after paid** ‚Äî ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥ (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ ADR ‡πÉ‡∏´‡∏°‡πà)
- ‚ùå **Edit prescription after confirmed** ‚Äî ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô `is_dispensed` ‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠ 6.3
- ‚ùå **Stock adjustment UI / manual stock correction** ‚Äî ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥

---

## Consequences

### Positive
- ‚úÖ Workflow ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á Staff
- ‚úÖ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô (reserved vs actual)
- ‚úÖ ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å Staff ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
- ‚úÖ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á `receipt_no` (‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô transactions ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)

### Negative
- ‚ö†Ô∏è ‡∏°‡∏µ migration ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ (status, is_dispensed, reserved_qty)
- ‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏´‡∏•‡∏≤‡∏¢‡∏à‡∏∏‡∏î (prescription list, summary sheet, etc.)
- ‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á implement guardrails ‡∏î‡πâ‡∏≤‡∏ô **atomic reserve/release** ‡πÅ‡∏•‡∏∞ **status locking** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô

---

## Alternatives Considered

### Option A: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô confirmed (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)
- **Rejected**: ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö workflow ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á Staff

### Option B: ‡∏™‡∏£‡πâ‡∏≤‡∏á `transaction_items` ‡πÅ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å `prescription_items`
- **Rejected**: ‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ, ‡πÄ‡∏û‡∏¥‡πà‡∏° `is_dispensed` flag ‡∏á‡πà‡∏≤‡∏¢‡∏Å‡∏ß‡πà‡∏≤

### Option C: ‡πÄ‡∏Å‡πá‡∏ö `final_amount` ‡πÅ‡∏¢‡∏Å‡πÉ‡∏ô prescriptions
- **Rejected**: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô, `transactions.total_amount` ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡πÅ‡∏•‡πâ‡∏ß

---

## Related

- [Sprint 4 PLAN.md](../../04-features/sprint-4/PLAN.md) ‚Äî DB migration + UI label only
- [Sprint 5 PLAN.md](../../04-features/sprint-5/PLAN.md) ‚Äî Workflow implementation
- [DATABASE_SCHEMA.md](../DATABASE_SCHEMA.md)

